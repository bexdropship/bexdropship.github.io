import{r as i,j as e,D as b,P as k,C as xe,S as W,B as me,I as q,T as d,Q as ge,H as ye,G as w,E as O,F as A,W as je}from"./index-DPzsDKEE.js";import{P as fe,C as be}from"./product-view-CvZZPf4e.js";import{D as E,a as N,b as z,c as I}from"./DialogTitle-zxs_Hjqz.js";import{F as M,T as S,L as _e}from"./LoadingButton-DRcGLGzK.js";import{C as ve}from"./customer-view-QRmoV_p-.js";import{e as Ce,f as Se,b as Pe,T as B,a as c,g as Te}from"./search-fill-bZtT5DWI.js";import{G as P}from"./Grid-B9eCkW66.js";import{C as qe}from"./Container-ZgPw_oXp.js";import{C as we}from"./Card-BEA1TmGE.js";import{u as Oe}from"./use-auth-Di4P8vUM.js";import"./Select-D5rpYej0.js";import"./isMuiElement-CCfVUV7u.js";function Q({onSelect:f}){const[m,g]=i.useState(!1),a=()=>{g(!0)},y=()=>{g(!1)},l=j=>{f(j),y()};return e.jsxs("div",{children:[e.jsx(b,{variant:"outlined",onClick:a,children:"Add Product"}),e.jsxs(E,{open:m,onClose:y,maxWidth:"xl",fullWidth:!0,children:[e.jsx(N,{children:"Products"}),e.jsx(z,{children:e.jsx(M,{sx:{width:"100%"},children:e.jsx(fe,{onSelect:l,style:{width:"100%"}})})}),e.jsx(I,{children:e.jsx(b,{onClick:y,color:"primary",children:"Close"})})]})]})}Q.propTypes={onSelect:k.func};function V({onSelect:f,filterParentContactOption:m}){const[g,a]=i.useState(!1),y=()=>{a(!0)},l=()=>{a(!1)},j=_=>{f(_),l()};return i.useEffect(()=>{console.log("DeliveryPopupModal Props:"),console.log("filterParentContactOption:",m)},[f,m]),e.jsxs("div",{children:[e.jsx(b,{variant:"outlined",onClick:y,children:"Set"}),e.jsxs(E,{open:g,onClose:l,maxWidth:"xl",fullWidth:!0,children:[e.jsx(N,{children:"Delivery Address"}),e.jsx(z,{sx:{padding:0},children:e.jsx(M,{sx:{width:"100%"},children:e.jsx(ve,{onSelect:j,filterTypeOption:"delivery",filterParentContactOption:m,style:{width:"100%"}})})}),e.jsx(I,{children:e.jsx(b,{onClick:l,color:"primary",children:"Close"})})]})]})}V.propTypes={onSelect:k.func,filterParentContactOption:k.number};function Ae(){const f=xe(),[m,g]=i.useState(!1),[a,y]=i.useState({id:0,name:"",street:"",city:"",state:"",country:"",zip:"",phone:"",mobile:"",email:""}),[l,j]=i.useState([]),[_,G]=i.useState({}),[H,K]=i.useState(0),[X,J]=i.useState(0),[Y,Z]=i.useState(0),[D,ee]=i.useState(""),[F,te]=i.useState(""),[$,re]=i.useState(""),R=new FileReader,L=i.useRef(null);function oe(t,o=","){let n=t.slice(0,t.indexOf(`
`)).split(o);return n=n.map(h=>h.replace(`
`,"").replace("\r","")),t.slice(t.indexOf(`
`)+1).split(`
`).map(h=>{const p=h.split(o).map(u=>u.replace(`
`,"").replace("\r",""));return n.reduce((u,x,C)=>(u[x]=p[C],u),{})})}const se=()=>{L.current.click()},ne=async t=>{const o=t.target.files[0];re(o.name),R.onload=async n=>{const r=oe(n.target.result);r.pop(),console.log(r);const s=[],h=r.map(p=>{const T=`${w.baseURL}/api-proxy/proxy?method=get&resource=products&exact_match=true&name=${p.sku}`;return console.log(T),O.get(T,{headers:{Authorization:`Bearer ${A.get("jwt")}`}}).then(u=>{if(console.log(u.data.data),Array.isArray(u.data.data)&&u.data.data.length===0)alert(`There appears to be an issue with your CSV file. Please review and correct it. Product ${p.sku} not found.`);else{const x=u.data.data[0];x.category=x.categ_id.name,x.attributes=x.product_template_attribute_value_ids.map(C=>`${C.attribute}:${C.name}`),x.product_uom_qty=Number(p.qty),s.push(x)}}).catch(u=>{console.error("Error fetching products:",u)})});await Promise.all(h),console.log(`Total products fetched: ${s.length}`),s.length===r.length&&(console.log("Setting products"),console.log(s),s.forEach(p=>{U(p,p.product_uom_qty)})),t.target.value=null},R.readAsText(o)},ae=t=>{console.log("Fetching order totals");const o=`${w.baseURL}/api-proxy/proxy?method=post&resource=ordertotals`;console.log(o);const r={order_line:l.map(s=>({product_id:s.id,product_uom_qty:s.product_uom_qty}))};console.log("Request body",r),O.post(o,r,{headers:{Authorization:`Bearer ${A.get("jwt")}`}}).then(s=>{console.log(s.data),G(s.data.result.product_prices),K(s.data.result.subtotal),J(s.data.result.total)}).catch(s=>{console.error("Error fetching order totals:",s)})};i.useEffect(()=>{ae();const t=l.reduce((o,n)=>o+n.product_uom_qty,0);Z(t)},[l]);const le=(t,o,n)=>{if(t<0||t>=l.length)return;const r=l.filter((s,h)=>h!==t);j(r)},ie=(t,o)=>{const n=l.map((r,s)=>{if(s===t){console.log(r),console.log(o);const h=["consu","service"];return r.qty_available<o&&!h.includes(r.type)?(alert("Quantity available is insufficient."),r):{...r,product_uom_qty:o!==0?Number(o):0}}return r});j(n)},v=t=>t?`$${t.toFixed(2)}`:"",ce=t=>{console.log("Setting order partner"),console.log(t),y({id:t.id,name:t.name,street:t.street,city:t.city,state:t.state,country:t.country,zip:t.zip,phone:t.phone,mobile:t.mobile,email:t.email})},U=(t,o)=>{console.log("Adding order line"),console.log(t);let n=!1;l.forEach(s=>{s.id===t.id&&(n=!0)});const r=["consu","service"];t.qty_available<1&&!r.includes(t.type)?alert(`Cannot add product lines with 0 qty available: SKU ${t.default_code}`):n?alert(`Product has already been added: SKU ${t.default_code}`):j(s=>[...s,{id:t.id,name:t.name,default_code:t.default_code,category:t.category,type:t.type,lst_price:t.lst_price,invoice_policy:t.invoice_policy,description_sale:t.description_sale,attributes:t.attributes,sale_ok:t.sale_ok,purchase_ok:t.purchase_ok,sales_count:t.sales_count,product_uom_qty:o||1,qty_available:t.qty_available}])},de=t=>{ee(t.target.value)},ue=t=>{te(t.target.value)},he=()=>{g(!0),console.log("Creating an order");const t=`${w.baseURL}/api-proxy/proxy?method=post&resource=orders`;console.log(t),console.log(l);const o=l.map(r=>({product_id:r.id,product_uom_qty:r.product_uom_qty}));console.log(o);const n={order:{order_line:o,x_studio_notes:D,client_order_ref:F,...a.id&&{partner_shipping_id:a.id}}};console.log("Request body",n),O.post(t,n,{headers:{Authorization:`Bearer ${A.get("jwt")}`}}).then(r=>{console.log(r.data),g(!1),f.push(`/orders/${r.data.result.sale_order_id}`)}).catch(r=>{console.error("Error fetching customers:",r)})},pe=e.jsxs(e.Fragment,{children:[e.jsx(W,{spacing:3,direction:"row",alignItems:"center",children:e.jsx(S,{fullWidth:!0,name:"partner_shipping_id",label:"Delivery Address",value:a.name,InputProps:{readOnly:!0,endAdornment:e.jsx(me,{display:"flex",alignItems:"center",children:e.jsx(q,{children:e.jsx(V,{onSelect:ce})})})}})}),a.name&&e.jsxs(e.Fragment,{children:[e.jsx("div",{style:{margin:"16px 0"}}),e.jsx(d,{variant:"body1",fontWeight:"bold",children:"Address:"}),e.jsx(d,{variant:"body1",children:a.street}),e.jsxs(d,{variant:"body1",children:[a.city," ",a.state]}),e.jsxs(d,{variant:"body1",children:[a.country," ",a.zip]}),e.jsxs(d,{variant:"body1",children:[e.jsx("b",{children:"Phone:"})," ",a.phone]}),e.jsxs(d,{variant:"body1",children:[e.jsx("b",{children:"Mobile:"})," ",a.mobile]}),e.jsxs(d,{variant:"body1",children:[e.jsx("b",{children:"Email:"})," ",a.email]})]}),e.jsx("div",{style:{margin:"16px 0"}}),e.jsx(q,{children:e.jsx(Q,{onSelect:U})}),e.jsx("input",{type:"file",accept:".csv",onChange:ne,ref:L,style:{display:"none"}}),e.jsx(b,{variant:"contained",color:"primary",onClick:se,children:"Upload CSV"}),$&&e.jsxs(d,{variant:"body1",style:{marginTop:"10px"},children:["Selected file: ",$]}),e.jsx("div",{style:{margin:"16px 0"}}),e.jsx(Ce,{component:ge,children:e.jsxs(Se,{children:[e.jsx(Pe,{children:e.jsxs(B,{children:[e.jsx(c,{children:"Product"}),e.jsx(c,{children:"Attributes"}),e.jsx(c,{children:"Unit Price"}),e.jsx(c,{children:"Qty Available"}),e.jsx(c,{children:"Qty"}),e.jsx(c,{children:"Subtotal"}),e.jsx(c,{})]})}),e.jsx(Te,{children:l.map((t,o)=>e.jsxs(B,{children:[e.jsxs(c,{children:["[",t.default_code,"] ",t.name]}),e.jsx(c,{children:t.attributes.map((n,r)=>e.jsx(be,{label:n,variant:"outlined"},r))}),e.jsx(c,{children:v(_[t.id])}),e.jsx(c,{children:t.qty_available}),e.jsx(c,{children:e.jsx(S,{type:"number",style:{minWidth:"100px"},value:t.product_uom_qty!==0?t.product_uom_qty:"",onChange:n=>ie(o,n.target.value)})}),e.jsx(c,{children:v(_[t.id]*t.product_uom_qty)}),e.jsx(c,{align:"right",children:e.jsx(q,{onClick:()=>le(o),children:e.jsx(ye,{icon:"eva:trash-2-outline"})})})]},o))})]})}),e.jsx("div",{style:{margin:"16px 0"}}),e.jsxs(d,{variant:"body1",fontWeight:"bold",children:["Total Product Qty: ",Y]}),e.jsxs(d,{variant:"body1",fontWeight:"bold",children:["Subtotal: ",v(H)]}),e.jsxs(d,{variant:"body1",fontWeight:"bold",children:["Total: ",v(X)]}),e.jsx("div",{style:{margin:"16px 0"}}),e.jsx(P,{container:!0,spacing:2,children:e.jsx(P,{item:!0,xs:12,md:6,lg:6,children:e.jsx(S,{label:"Notes",value:D,multiline:!0,fullWidth:!0,rows:4,onChange:de})})}),e.jsx("div",{style:{margin:"16px 0"}}),e.jsx(P,{container:!0,spacing:2,children:e.jsx(P,{item:!0,xs:12,md:6,lg:6,children:e.jsx(S,{label:"PO Number",value:F,fullWidth:!0,onChange:ue})})}),e.jsx("div",{style:{margin:"16px 0"}}),e.jsx(_e,{fullWidth:!0,size:"large",type:"submit",variant:"contained",color:"inherit",onClick:he,loading:m,children:"Create"})]});return e.jsxs(qe,{children:[e.jsx(W,{direction:"row",alignItems:"center",justifyContent:"space-between",mb:5,children:e.jsx(d,{variant:"h4",children:"New Order"})}),pe,e.jsx(we,{})]})}function Ie(){return Oe(),e.jsxs(e.Fragment,{children:[e.jsx(je,{children:e.jsx("title",{children:" New Order | BEX Dropship "})}),e.jsx(Ae,{})]})}export{Ie as default};
